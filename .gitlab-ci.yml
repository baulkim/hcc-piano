stages:
  - init
  - test
  - build
  - deploy

before_script:
  - export GOROOT="/usr/local/go"
  - export GOPATH="/home/gitlab-runner/go"
  - export PATH="$PATH:$GOROOT/bin:$GOPATH/bin"
  - export GOPROXY=direct

copy_dir:
  stage: init
  script:
    - make copy_dir
    - ln -sf $GOPATH/src/hcc/pb ../pb
    - ln -sf $GOPATH/src/hcc/hcc_errors ../hcc_errors

unit_tests:
  stage: test
  script:
    - make test

race_detector:
  stage: test
  script:
    - make race

code_coverage:
  stage: test
  script:
    - make coverage

go_report:
  stage: test
  script:
    - make goreport

build:
  stage: build
  script:
    - make

deploy:
  stage: deploy
  script:
    - make # Binary file is removed at start of new stage. Rebuild.
    - sudo /usr/sbin/service piano stop
    - sudo cp $PWD/piano /bin/piano
    - sudo chmod 755 /bin/piano
    - sudo /usr/sbin/service piano start
    - echo "Finished"
  only:
  - master
